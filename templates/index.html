<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Ma Liste de T√¢ches</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>

<body>
    <div class="container">

        <h1>üìã Ma Liste de T√¢ches</h1>

        <form method="POST" action="/add" class="add-form">
            <!-- Ligne 1 : t√¢che seule -->
            <input type="text" name="task" placeholder="Nouvelle t√¢che" required>

            <!-- Ligne 2 : statut, cat√©gorie, priorit√©, bouton -->
            <div class="add-form-bottom">
                <select name="status" required>
                    <option value="√† faire">√Ä faire</option>
                    <option value="en cours">En cours</option>
                    <option value="termin√©">Termin√©</option>
                </select>

                <select name="category" id="category-select" required>
                    <option value="" disabled selected>Cat√©gorie</option>
                    {% for cat in categories %}
                    {% if cat.name != 'Non sp√©cifi√©e' %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endif %}
                    {% endfor %}
                    <option value="new">‚ûï Ajouter une cat√©gorie...</option>
                </select>

                <select name="priority" required>
                    <option value="" disabled selected>Priorit√©</option>
                    {% for prio in priorities %}
                    <option value="{{ prio.id }}">{{ prio.level }}</option>
                    {% endfor %}
                </select>

                <button type="submit" class="add-button">Ajouter</button>
            </div>
        </form>


        <form method="GET" action="/" class="filter-form">
            <div class="filter-line">
                <select name="category">
                    <option value="all">Toutes les cat√©gories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>

                <select name="priority">
                    <option value="all">Toutes les priorit√©s</option>
                    {% for prio in priorities %}
                    <option value="{{ prio.id }}">{{ prio.level }}</option>
                    {% endfor %}
                </select>

                <select name="status">
                    <option value="all">Tous les statuts</option>
                    <option value="√† faire">√Ä faire</option>
                    <option value="en cours">En cours</option>
                    <option value="termin√©">Termin√©</option>
                </select>
            </div>

            <div class="filter-submit">
                <button type="submit">Filtrer</button>
            </div>
        </form>



        <ul class="task-list">
            {% for task in todos %}
            <li>
                <div class="task-box">
                    <div class="task-left">
                        <strong>{{ task.task }}</strong>
                    </div>

                    <div class="task-right">
                        <div class="task-meta">
                            <span class="category-tag">üìÇ {{ task.category_name or "Non sp√©cifi√©e" }}</span>
                            <span class="priority-tag {{ task.priority_level|lower }}">üî• {{ task.priority_level
                                }}</span>
                        </div>

                        <div class="task-actions">
                            <form method="POST" action="/update/{{ task.id }}">
                                <select name="status" class="task-status" onchange="this.form.submit()">
                                    <option value="√† faire" {% if task.status=='√† faire' %}selected{% endif %}>√Ä faire
                                    </option>
                                    <option value="en cours" {% if task.status=='en cours' %}selected{% endif %}>En
                                        cours</option>
                                    <option value="termin√©" {% if task.status=='termin√©' %}selected{% endif %}>Termin√©
                                    </option>
                                </select>
                            </form>

                            <form method="POST" action="/delete/{{ task.id }}">
                                <button type="submit" class="delete-btn" title="Supprimer">&#128465;</button>
                            </form>
                        </div>
                    </div>

                </div>

            </li>
            {% endfor %}
        </ul>
        <form method="POST" action="/logout" class="logout-form">
            <button type="submit">D√©connexion</button>
        </form>

    </div>
    <script>
        document.getElementById('category-select').addEventListener('change', function () {
            if (this.value === 'new') {
                const newCat = prompt("Nom de la nouvelle cat√©gorie :");
                if (newCat && newCat.trim() !== "") {
                    fetch('/add_category', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newCat.trim() })
                    })
                        .then(response => {
                            if (response.ok) {
                                location.reload();
                            } else {
                                alert("Erreur lors de l'ajout de la cat√©gorie.");
                            }
                        });
                } else {
                    this.value = "";  // reset si l'utilisateur annule
                }
            }
        });
    </script>

</body>

</html>